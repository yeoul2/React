import { useState, useEffect, useRef, useCallback } from "react";
import { fetchAutocomplete } from "../../services/googlePlacesService"; // âœ… API í˜¸ì¶œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
import debounce from "lodash.debounce"; // âœ… Debounceë¥¼ ì‚¬ìš©í•˜ì—¬ API ìš”ì²­ ìµœì í™”
// âœ… RESTful API ìš”ì²­ì„ travelSearchLogic.jsì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ë³€ê²½
import {
  getRecentSearches, // ìµœê·¼ ê²€ìƒ‰ì–´ ëª©ë¡ ì¡°íšŒ
  saveSearch, // ê²€ìƒ‰ì–´ ì €ì¥
  deleteRecentSearch, // ê²€ìƒ‰ì–´ ì‚­ì œ
  getPopularDestinations, // ì¸ê¸° ì—¬í–‰ì§€ ëª©ë¡ ì¡°íšŒ
} from "../../services/travelSearchLogic";

// ğŸ”½ ì»¤ìŠ¤í…€ í›… ìƒì„±: ì—¬í–‰ ê²€ìƒ‰ ê´€ë ¨ ìƒíƒœì™€ ê¸°ëŠ¥ì„ ê´€ë¦¬
const useTravelSearch = () => {
  const [isLoggedIn, setIsLoggedIn] = useState(false); // ğŸ”¹ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  const [searchTerm, setSearchTerm] = useState(""); // ğŸ”¹ ê²€ìƒ‰ì–´ ìƒíƒœ
  const [showResults, setShowResults] = useState(false); // ğŸ”¹ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì—¬ë¶€
  const [selectedCity, setSelectedCity] = useState(""); // ğŸ”¹ ì„ íƒëœ ë„ì‹œ
  const [recentSearches, setRecentSearches] = useState([]); // ğŸ”¹ ìµœê·¼ ê²€ìƒ‰ì–´ ëª©ë¡
  const [popularDestinations, setPopularDestinations] = useState([]); // ğŸ”¹ ì¸ê¸° ì—¬í–‰ì§€ ëª©ë¡
  const [suggestedCombined, setSuggestedCombined] = useState([]); // ğŸ”¹ ìë™ì™„ì„± ì¶”ì²œ ê²°ê³¼
  const searchResultsRef = useRef(null); // ğŸ”¹ ê²€ìƒ‰ ê²°ê³¼ DOM ì˜ì—­ ì°¸ì¡°
  const [isSearching, setIsSearching] = useState(false); // ìë™ì™„ì„± ê²°ê³¼ ê°±ì‹  í•¨ìˆ˜

  // âœ… [ì¶”ê°€] ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ìë™ì™„ì„± API í˜¸ì¶œ
  useEffect(() => {
    const fetchSuggestions = async () => {
      if (!searchTerm.trim()) {
        setSuggestedCombined([]);
        setShowResults(false);
        return;
      }

      try {
        setIsSearching(true); // ë¡œë”© ì‹œì‘
        const results = await fetchAutocomplete(searchTerm);
        updateSuggestedCombined(results);
        setShowResults(true); // ìë™ì™„ì„± ê²°ê³¼ í‘œì‹œ
      } catch (error) {
        console.error("âŒ ìë™ì™„ì„± API í˜¸ì¶œ ì˜¤ë¥˜:", error);
      } finally {
        setIsSearching(false); // ë¡œë”© ì¢…ë£Œ
      }
    };

    fetchSuggestions();
  }, [searchTerm]);

  // âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ìµœê·¼ ê²€ìƒ‰ì–´ ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    const checkLoginStatus = async () => {
      const accessToken = localStorage.getItem("accessToken");
      const userId = localStorage.getItem("user_id");

      if (accessToken && userId) {
        setIsLoggedIn(true);
        try {
          const searches = await getRecentSearches(userId, accessToken);
          setRecentSearches(Array.isArray(searches) ? searches : []);
        } catch (error) {
          console.error("âŒ ìµœê·¼ ê²€ìƒ‰ì–´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
      } else {
        setIsLoggedIn(false);
        setRecentSearches([]); // ë¡œê·¸ì•„ì›ƒ ì‹œ ì´ˆê¸°í™”
      }
    };

    checkLoginStatus();
    window.addEventListener("storage", checkLoginStatus);
    return () => window.removeEventListener("storage", checkLoginStatus);
  }, []);

  // âœ… ì¸ê¸° ì—¬í–‰ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    const loadPopular = async () => {
      try {
        const data = await getPopularDestinations();
        console.log("ğŸ”¥ ì¸ê¸° ì—¬í–‰ì§€ ì‘ë‹µ:", data);
        setPopularDestinations(data);
      } catch (error) {
        console.error("âŒ ì¸ê¸° ì—¬í–‰ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
      }
    };
    loadPopular();
  }, []);

  // âœ… ê²€ìƒ‰ì–´ ì €ì¥
  const handleSaveSearch = async (term, type = "city") => {
    if (!isLoggedIn) return;
    try {
      const accessToken = localStorage.getItem("accessToken");
      await saveSearch(term, type, accessToken);
      const userId = localStorage.getItem("user_id");
      const updated = await getRecentSearches(userId, accessToken);
      setRecentSearches(updated);
    } catch (error) {
      console.error("âŒ ê²€ìƒ‰ì–´ ì €ì¥ ì‹¤íŒ¨:", error);
    }
  };

  // âœ… ê²€ìƒ‰ì–´ ì‚­ì œ
  const handleRemoveRecentSearch = async (term, type = "city") => {
    if (!isLoggedIn) return;
    try {
      const accessToken = localStorage.getItem("accessToken");
      await deleteRecentSearch(term, accessToken); // type ì œê±°
      const userId = localStorage.getItem("user_id");
      const updated = await getRecentSearches(userId, accessToken);
      setRecentSearches(updated);
    } catch (error) {
      console.error("âŒ ê²€ìƒ‰ì–´ ì‚­ì œ ì‹¤íŒ¨:", error);
    }
  };

  // âœ… ìë™ì™„ì„± ê²°ê³¼ ê°±ì‹ 
  const updateSuggestedCombined = (results) => {
    setSuggestedCombined(results || []);
  };

  // âœ… ë„ì‹œ ì„ íƒ ì²˜ë¦¬
  const handleCitySelect = (city) => {
    setSelectedCity(city);
    setSearchTerm(city);
    setShowResults(false);
  };

  // âœ… ì¸ê¸° ì—¬í–‰ì§€ ì„ íƒ ì²˜ë¦¬
  const handlePopularDestinationSelect = async (destination) => {
    setSearchTerm(destination);
    setSelectedCity(destination);
    setShowResults(false);

    if (!isLoggedIn) {
      console.log("âŒ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ - ê²€ìƒ‰ì–´ ì €ì¥ ì•ˆ í•¨");
      return; // ğŸ“Œ ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
    }

    try {
      const accessToken = localStorage.getItem("accessToken");
      // âœ… RESTful API í˜¸ì¶œë¡œ ë³€ê²½
      const updatedSearches = await saveSearch(
        destination,
        "city",
        accessToken
      );
      setRecentSearches(updatedSearches);

      console.log("âœ… ì¸ê¸° ì—¬í–‰ì§€ ì„ íƒ ë° ê²€ìƒ‰ì–´ ì €ì¥ ì™„ë£Œ:", destination);
    } catch (error) {
      console.error("âŒ ê²€ìƒ‰ì–´ ì €ì¥ ì‹¤íŒ¨:", error);
    }
  };

  // âœ… ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°
  const handleClickOutside = (event) => {
    if (
      searchResultsRef.current &&
      !searchResultsRef.current.contains(event.target)
    ) {
      setShowResults(false);
    }
  };

  // âœ… ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
  const handleClearSearch = () => {
    setSearchTerm("");
    setSelectedCity("");
    setShowResults(false);
    setSuggestedCombined([]);
  };

  return {
    isLoggedIn, // ğŸ”¹ ë¡œê·¸ì¸ ì—¬ë¶€ ì¶”ê°€
    currentUser, // ğŸ”¹ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
    searchTerm, // ğŸ”¹ ê²€ìƒ‰ì–´ ìƒíƒœ
    showResults, // ğŸ”¹ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì—¬ë¶€
    selectedCity, // ğŸ”¹ ì„ íƒëœ ë„ì‹œ
    setSelectedCity, // âœ… ì´ ì¤„ ì¶”ê°€!!
    recentSearches, // ğŸ”¹ ìµœê·¼ ê²€ìƒ‰ì–´ ëª©ë¡
    suggestedCities, // ğŸ”¹ ì¶”ì²œ ë„ì‹œ ëª©ë¡
    popularDestinations, // ğŸ”¹ ì¸ê¸° ì—¬í–‰ì§€ ëª©ë¡
    searchResultsRef, // ğŸ”¹ ê²€ìƒ‰ ê²°ê³¼ DOM ì°¸ì¡°
    handleCountryChange, // ğŸ”¹ ë‚˜ë¼ ì…ë ¥ ì‹œ ìë™ì™„ì„± ì²˜ë¦¬
    fetchPlaces, // ğŸ”¹ ê³µí†µ ê²€ìƒ‰ í•¨ìˆ˜
    saveSearch, // ğŸ”¹ ê²€ìƒ‰ì–´ ì €ì¥ í•¨ìˆ˜ (ë°±ì—”ë“œ API í˜¸ì¶œ)
    setSearchTerm, // ğŸ”¹ ê²€ìƒ‰ì–´ ë³€ê²½ í•¨ìˆ˜
    setShowResults, // ğŸ”¹ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì—¬ë¶€ ì„¤ì •
    handleClearSearch, // ğŸ”¹ ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
    handleCitySelect, // ğŸ”¹ ë„ì‹œ ì„ íƒ ì²˜ë¦¬
    handleCountrySelect, // ğŸ”¹ ë‚˜ë¼ ì„ íƒ ì²˜ë¦¬
    handlePopularDestinationSelect, // ğŸ”¹ ì¸ê¸° ì—¬í–‰ì§€ ì„ íƒ ì²˜ë¦¬
    handleClickOutside, // ğŸ”¹ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    getSuggestedCities, // ğŸ”¹ ë„ì‹œ ì¶”ì²œ ê¸°ëŠ¥ (ë”ë¯¸ ë°ì´í„° + API ì‚¬ìš©)
    handleRemoveRecentSearch, // ğŸ”¹ ìµœê·¼ ê²€ìƒ‰ì–´ ì‚­ì œ
    updateRecentSearches, // ğŸ”¹ ìµœê·¼ ê²€ìƒ‰ì–´ ì—…ë°ì´íŠ¸
  };
};

export default useTravelSearch;
