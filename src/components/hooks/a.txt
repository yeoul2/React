import { useState, useEffect, useRef, useCallback } from "react";
import axios from "axios"; // ğŸ”¹ ë°±ì—”ë“œ API í˜¸ì¶œì„ ìœ„í•œ axios ì¶”ê°€
import { fetchAutocomplete } from "../../services/googlePlacesService"; // âœ… êµ¬ê¸€ í”Œë ˆì´ìŠ¤ API ìœ ì§€ (ê²€ìƒ‰ ê¸°ëŠ¥ì— í•„ìš”!)

const useTravelSearch = () => {
  // âœ… í•„ìš”í•œ ìƒíƒœ ë³€ìˆ˜ë§Œ ìœ ì§€
  const [isLoggedIn, setIsLoggedIn] = useState(false); // ë¡œê·¸ì¸ ì—¬ë¶€
  const [currentUser, setCurrentUser] = useState(null); // í˜„ì¬ ì‚¬ìš©ì ì •ë³´
  const [searchTerm, setSearchTerm] = useState(""); // ê²€ìƒ‰ì–´ ìƒíƒœ
  const [showResults, setShowResults] = useState(false); // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì—¬ë¶€
  const [selectedCountry, setSelectedCountry] = useState(""); // ğŸ”¹ ë‚˜ë¼ ì„ íƒ (ìœ ì§€)
  const [selectedCity, setSelectedCity] = useState(""); // ì„ íƒëœ ë„ì‹œ
  const [recentSearches, setRecentSearches] = useState(
    JSON.parse(localStorage.getItem("recentSearches")) || []
  ); // ìµœê·¼ ê²€ìƒ‰ì–´ ëª©ë¡
  const [popularDestinations, setPopularDestinations] = useState([]); // ì¸ê¸° ì—¬í–‰ì§€ ëª©ë¡

  const searchResultsRef = useRef(null); // ğŸ”¹ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ê°ì§€ë¥¼ ìœ„í•œ Ref

  // ğŸ“Œ ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
  const checkLoginStatus = useCallback(() => {
    const accessToken = localStorage.getItem("accessToken");
    const userId = localStorage.getItem("user_id");
    if (accessToken && userId) {
      setIsLoggedIn(true);
      setCurrentUser({ id: userId });
    } else {
      setIsLoggedIn(false);
      setCurrentUser(null);
    }
  }, []);

  useEffect(() => {
    checkLoginStatus(); // âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    window.addEventListener("storage", checkLoginStatus); // âœ… ë¡œê·¸ì¸ ë³€ê²½ ê°ì§€

    return () => window.removeEventListener("storage", checkLoginStatus);
  }, [checkLoginStatus]);

  // ğŸ“Œ ì¸ê¸° ì—¬í–‰ì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ë°±ì—”ë“œ API ì—°ë™)
  useEffect(() => {
    const fetchPopularDestinations = async () => {
      try {
        const response = await axios.get("/api/search/popular");
        if (response.data?.length > 0) {
          setPopularDestinations(response.data);
        }
      } catch (error) {
        console.error("âŒ ì¸ê¸° ì—¬í–‰ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
      }
    };

    fetchPopularDestinations();
  }, []);

  /**
   * ğŸ“Œ í•˜ë‚˜ì˜ í•¨ìˆ˜ë¡œ êµ­ê°€, ë„ì‹œ, ìƒì„¸ ì£¼ì†Œë¥¼ êµ¬ë¶„í•˜ì—¬ ê²€ìƒ‰í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
   *
   * @param {string} query ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê²€ìƒ‰ì–´
   * @param {string} type ê²€ìƒ‰ íƒ€ì…: 'regions' | 'cities' | 'geocode'
   * @param {function} setSuggestions ê²°ê³¼ê°’ì„ ìƒíƒœì— ì €ì¥í•  í•¨ìˆ˜ (ì˜ˆ: setSuggestedCountries)
   */
  const fetchPlaces = useCallback(async (query, type, setSuggestions) => {
    if (!query) return;

    try {
      const results = await fetchAutocomplete(query, type); // âœ… googlePlacesApi.jsì—ì„œ ê°€ì ¸ì˜¤ê¸°
      setSuggestions(results);
    } catch (error) {
      console.error("Google Places API ì¥ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜:", error);
    }
  }, []);

  // ğŸ“Œ ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ìë™ì™„ì„± ì²˜ë¦¬
  const handleCountryChange = async (e) => {
    const query = e.target.value;
    setSearchTerm(query); // ğŸ”¹ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê²€ìƒ‰ì–´ë¥¼ ìƒíƒœì— ì €ì¥
    setShowResults(true); // ğŸ”¹ ìë™ì™„ì„± ëª©ë¡ì„ í™”ë©´ì— í‘œì‹œ

    try {
      const results = await fetchAutocomplete(query, "regions"); // âœ… API í˜¸ì¶œ ë³€ê²½
      // ì—¬ê¸°ì„œ ìë™ì™„ì„± ê²°ê³¼ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë¡œì§ì„ ì¶”ê°€ (ì˜ˆ: í™”ë©´ì— í‘œì‹œ)
    } catch (error) {
      console.error("API í˜¸ì¶œ ì˜¤ë¥˜:", error);
    }
  };

  // ğŸ“Œ ë‚˜ë¼ ê²€ìƒ‰ (êµ¬ê¸€ í”Œë ˆì´ìŠ¤ API í™œìš©)
  const handleCountrySearch = async (query) => {
    if (!query) return;
    setSearchTerm(query);
    setShowResults(true);

    try {
      const results = await fetchAutocomplete(query, "regions"); // ğŸ”¹ êµ¬ê¸€ APIì—ì„œ ë‚˜ë¼ ê²€ìƒ‰ ê²°ê³¼ ê°€ì ¸ì˜´
      console.log("ğŸ” ë‚˜ë¼ ê²€ìƒ‰ ê²°ê³¼:", results);
    } catch (error) {
      console.error("âŒ ë‚˜ë¼ ê²€ìƒ‰ ì‹¤íŒ¨:", error);
    }
  };

  // ğŸ“Œ ë„ì‹œ ì„ íƒ í•¸ë“¤ëŸ¬ (ê²€ìƒ‰ì–´ ë° UI ì—…ë°ì´íŠ¸)
  const handleCitySelect = async (city, country) => {
    const fullCity = `${city}, ${country}`;
    setSelectedCity(fullCity);
    setSearchTerm(fullCity);
    setShowResults(false);
    updateRecentSearches(fullCity);

    if (!isLoggedIn) return;

    try {
      await axios.post("/api/search/save", {
        userId: currentUser.id,
        searchTerm: fullCity,
      });
    } catch (error) {
      console.error("âŒ ê²€ìƒ‰ì–´ ì €ì¥ ì‹¤íŒ¨:", error);
    }
  };

  // ğŸ“Œ ìµœê·¼ ê²€ìƒ‰ì–´ ì—…ë°ì´íŠ¸ (ìµœëŒ€ 10ê°œ ì €ì¥)
  const updateRecentSearches = (search) => {
    if (!isLoggedIn) return;

    setRecentSearches((prev) => {
      const updated = [search, ...prev.filter((item) => item !== search)].slice(
        0,
        10
      );
      localStorage.setItem(
        `recentSearches_${currentUser.id}`,
        JSON.stringify(updated)
      );
      return updated;
    });
  };

  // ğŸ“Œ ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
  const handleClearSearch = () => {
    setSearchTerm("");
    setShowResults(false);
    setSelectedCity("");
  };

  // ğŸ“Œ ìµœê·¼ ê²€ìƒ‰ì–´ ì‚­ì œ ê¸°ëŠ¥
  const handleRemoveRecentSearch = (searchToRemove) => {
    const updatedSearches = recentSearches.filter(
      (search) => search !== searchToRemove
    );
    setRecentSearches(updatedSearches);

    if (isLoggedIn) {
      localStorage.setItem(
        `recentSearches_${currentUser.id}`,
        JSON.stringify(updatedSearches)
      );
    } else {
      localStorage.setItem("recentSearches", JSON.stringify(updatedSearches));
    }
  };

  // ğŸ“Œ ì¸ê¸° ì—¬í–‰ì§€ ì„ íƒ í•¸ë“¤ëŸ¬
  const handlePopularDestinationSelect = async (destination) => {
    setSearchTerm(destination);
    setSelectedCity(destination);
    setShowResults(false);
    updateRecentSearches(destination);

    if (!isLoggedIn) return;

    try {
      await axios.post("/api/search/save", {
        userId: currentUser.id,
        searchTerm: destination,
      });
    } catch (error) {
      console.error("âŒ ê²€ìƒ‰ì–´ ì €ì¥ ì‹¤íŒ¨:", error);
    }
  };

  // ğŸ“Œ ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°
  const handleClickOutside = (event) => {
    if (
      searchResultsRef.current &&
      !searchResultsRef.current.contains(event.target)
    ) {
      setShowResults(false);
    }
  };

  return {
    isLoggedIn,
    currentUser,
    searchTerm,
    showResults,
    selectedCountry, // âœ… ë‚˜ë¼ ì„ íƒ ìƒíƒœ ìœ ì§€
    selectedCity,
    recentSearches,
    popularDestinations,
    searchResultsRef,
    handleCountrySearch, // âœ… ë‚˜ë¼ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
    handleCitySelect,
    handleClearSearch,
    handleRemoveRecentSearch,
    handlePopularDestinationSelect,
    handleClickOutside,
  };
};

export default useTravelSearch;
